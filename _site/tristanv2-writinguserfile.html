<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" userfile, setup, domain, fields, initialize">
<title>Writing a user file | Tristan v2 Wiki</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="tristan-v2" href="http://localhost:4000/feed.xml">

    <script>
        // $(document).ready(function() {
        //     // Initialize navgoco with default options
        //     $("#mysidebar").navgoco({
        //         caretHtml: '',
        //         accordion: false,
        //         openClass: 'active', // open
        //         save: false, // leave false or nav highlighting doesn't work right
        //         cookie: {
        //             name: 'navgoco',
        //             expires: false,
        //             path: '/'
        //         },
        //         slide: {
        //             duration: 400,
        //             easing: 'swing'
        //         }
        //     });
        //
        //     $("#collapseAll").click(function(e) {
        //         e.preventDefault();
        //         $("#mysidebar").navgoco('toggle', false);
        //     });
        //
        //     $("#expandAll").click(function(e) {
        //         e.preventDefault();
        //         $("#mysidebar").navgoco('toggle', true);
        //     });
        //
        // });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    
    <script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [             // start/end delimiter pairs for display math
      ['$$', '$$'],
      ['\\[', '\\]']
    ]
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Tristan v2 Documentation</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="https://github.com/PrincetonUniversity/tristan-v2" target="_blank" rel="noopener">Tristan v2 GitHub</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                <!-- 
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:?subject= feedback&body=I have some feedback about the Writing a user file page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

</li>

		 -->
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Writing a user file">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">Tristan v2</li>
  
  
  
  <li>
      <a title="Home" href="#">Home</a>
      <ul>
          
          
          
          <li><a title="Latest updates" href="index.html">Latest updates</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Getting Started" href="#">Getting Started</a>
      <ul>
          
          
          
          <li><a title="Configuring, compiling, running" href="tristanv2-configure.html">Configuring, compiling, running</a></li>
          
          
          
          
          
          
          <li><a title="Input file" href="tristanv2-inputfile.html">Input file</a></li>
          
          
          
          
          
          
          <li><a title="User file" href="tristanv2-userfile.html">User file</a></li>
          
          
          
          
          
          
          <li><a title="Visualization" href="tristanv2-visualization.html">Visualization</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Code Description" href="#">Code Description</a>
      <ul>
          
          
          
          <li><a title="Particle-in-cell concept" href="tristanv2-pic-concept.html">Particle-in-cell concept</a></li>
          
          
          
          
          
          
          <li><a title="Simulation units" href="tristanv2-sim-units.html">Simulation units</a></li>
          
          
          
          
          
          
          <li><a title="Structure of memory" href="tristanv2-structure.html">Structure of memory</a></li>
          
          
          
          
          
          
          <li><a title="Numerical algorithms" href="tristanv2-algorithms.html">Numerical algorithms</a></li>
          
          
          
          
          
          
          <li><a title="Load balancing" href="tristanv2-loadbal.html">Load balancing</a></li>
          
          
          
          
          
          
          <li><a title="Radiation" href="tristanv2-radiation.html">Radiation</a></li>
          
          
          
          
          
          
          <li><a title="QED" href="tristanv2-qed.html">QED</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Useful Guides" href="#">Useful Guides</a>
      <ul>
          
          
          
          <li class="active"><a title="Writing a user file" href="tristanv2-writinguserfile.html">Writing a user file</a></li>
          
          
          
          
          
          
          <li><a title="Supported flags" href="tristanv2-confflags.html">Supported flags</a></li>
          
          
          
          
          
          
          <li><a title="Coding style" href="tristanv2-codestyle.html">Coding style</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block: -->
     <!-- <p class="external">
         <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
     </p> -->

</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Writing a user file</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

   <p>In this section we are going to learn the basics of writing a user file in <code class="language-plaintext highlighter-rouge">Tristan v2</code>.</p>

<p>As an example we are going to write a user file for a two dimensional double periodic reconnection setup, since it involves some of the most basic and necessary routines and building blocks.</p>

<p>Start by copying and renaming the default <code class="language-plaintext highlighter-rouge">user/user_dummy.F90</code> (to, say, <code class="language-plaintext highlighter-rouge">user/user_myrec.F90</code>) as it contains the most up-to-date default routines for initialization that we’ll need to be filling in.</p>

<h3 id="reading-input-parameters">Reading input parameters</h3>
<p>First we will need to read the setup parameters from the input file and store them in some local variables. For that we can use the <code class="language-plaintext highlighter-rouge">getInput()</code> routine inside of the <code class="language-plaintext highlighter-rouge">userReadInput()</code>. There you need to specify the block (<code class="language-plaintext highlighter-rouge">&lt;problem&gt;</code>), the variable name and the variable itself (we will declare them later). This is what the code looks like.</p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">subroutine</span><span class="w"> </span><span class="n">userReadInput</span><span class="p">()</span><span class="w">
  </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
  </span><span class="k">call</span><span class="w"> </span><span class="n">getInput</span><span class="p">(</span><span class="s1">'problem'</span><span class="p">,</span><span class="w"> </span><span class="s1">'upstream_T'</span><span class="p">,</span><span class="w"> </span><span class="n">upstream_T</span><span class="p">)</span><span class="w">      </span><span class="c1">! &lt;- upstream temperature</span><span class="w">
  </span><span class="k">call</span><span class="w"> </span><span class="n">getInput</span><span class="p">(</span><span class="s1">'problem'</span><span class="p">,</span><span class="w"> </span><span class="s1">'nCS_nUP'</span><span class="p">,</span><span class="w"> </span><span class="n">nCS_over_nUP</span><span class="p">)</span><span class="w">       </span><span class="c1">! &lt;- density of the current sheet / density upstream</span><span class="w">
  </span><span class="k">call</span><span class="w"> </span><span class="n">getInput</span><span class="p">(</span><span class="s1">'problem'</span><span class="p">,</span><span class="w"> </span><span class="s1">'current_width'</span><span class="p">,</span><span class="w"> </span><span class="n">current_width</span><span class="p">)</span><span class="w">
  </span><span class="n">cs_x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="p">;</span><span class="w"> </span><span class="n">cs_x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="w"> </span><span class="c1">! &lt;- positions of current sheets (as a fraction of the global size)</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">userReadInput</span><span class="w">
</span></code></pre></div></div>
<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> There is no need to specify the variable type (<code class="language-plaintext highlighter-rouge">real</code>/<code class="language-plaintext highlighter-rouge">integer</code>/<code class="language-plaintext highlighter-rouge">logical</code>), as the function <code class="language-plaintext highlighter-rouge">getInput</code> will do the necessary conversion itself, given the type from the variable declaration (see below).</div>

<p>Also don’t forget to declare all these variables in the top:</p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">!--- PRIVATE variables -----------------------------------------!</span><span class="w">
</span><span class="kt">real</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">upstream_T</span><span class="p">,</span><span class="w"> </span><span class="n">current_width</span><span class="p">,</span><span class="w"> </span><span class="n">cs_x1</span><span class="p">,</span><span class="w"> </span><span class="n">cs_x2</span><span class="p">,</span><span class="w"> </span><span class="n">nCS_over_nUP</span><span class="w">
</span><span class="k">private</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">upstream_T</span><span class="p">,</span><span class="w"> </span><span class="n">current_width</span><span class="p">,</span><span class="w"> </span><span class="n">cs_x1</span><span class="p">,</span><span class="w"> </span><span class="n">cs_x2</span><span class="p">,</span><span class="w"> </span><span class="n">nCS_over_nUP</span><span class="w">
</span><span class="c1">!...............................................................!</span><span class="w">
</span></code></pre></div></div>
<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> making them private is optional and is primarily for safety reasons.</div>

<p>To pass the desired values, we need to add the following block to the <code class="language-plaintext highlighter-rouge">input</code> file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;problem&gt;

  upstream_T      <span class="o">=</span> 1e-5           <span class="c"># temperature in terms of [m_e c**2]</span>
  nCS_nUP         <span class="o">=</span> 3.0
  current_width   <span class="o">=</span> 10
</code></pre></div></div>

<h3 id="initializing-particles">Initializing particles</h3>
<p>After we are done with the variables, we can initialize the particles, which is done in the conveniently named <code class="language-plaintext highlighter-rouge">userInitParticles()</code> routine. First we’ll need to declare a few variables:</p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">real</span><span class="w">            </span><span class="p">::</span><span class="w"> </span><span class="n">nUP</span><span class="p">,</span><span class="w"> </span><span class="n">nCS</span><span class="w">
</span><span class="k">type</span><span class="p">(</span><span class="n">region</span><span class="p">)</span><span class="w">    </span><span class="p">::</span><span class="w"> </span><span class="n">fill_region</span><span class="w">
</span><span class="kt">real</span><span class="w">            </span><span class="p">::</span><span class="w"> </span><span class="n">sx_glob</span><span class="p">,</span><span class="w"> </span><span class="n">sy_glob</span><span class="p">,</span><span class="w"> </span><span class="n">shift_gamma</span><span class="p">,</span><span class="w"> </span><span class="n">shift_beta</span><span class="p">,</span><span class="w"> </span><span class="n">current_sheet_T</span><span class="w">
</span><span class="k">procedure</span><span class="w"> </span><span class="p">(</span><span class="n">spatialDistribution</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">spat_distr_ptr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">null</span><span class="p">()</span><span class="w">
</span><span class="n">spat_distr_ptr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">userSpatialDistribution</span><span class="w">
</span></code></pre></div></div>
<p>The last two lines are from the <code class="language-plaintext highlighter-rouge">user_dummy.F90</code>, they are to specify the spatial distribution function of injected plasma. Let us leave them aside for now and get back to them later.</p>

<p>After we’ve declared these variables we can define the upstream and current sheet densities as well as the initial temperature and the current density of the current sheets, necessary to balance the <code class="language-plaintext highlighter-rouge">curl B</code> and <code class="language-plaintext highlighter-rouge">B^2</code> (the following is for the electron-positron plasma).</p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nUP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ppc0</span><span class="w">
</span><span class="n">nCS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nUP</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nCS_over_nUP</span><span class="w">

</span><span class="c1">! initial drift velocity of the current sheet</span><span class="w">
</span><span class="c1">!     to ensure `curlB = j`</span><span class="w">
</span><span class="n">shift_beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c_omp</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="p">(</span><span class="n">current_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nCS_over_nUP</span><span class="p">)</span><span class="w">
</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shift_beta</span><span class="w"> </span><span class="ow">.gt.</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
  </span><span class="c1">! making sure `beta &lt; 1`</span><span class="w">
  </span><span class="k">call</span><span class="w"> </span><span class="n">throwError</span><span class="p">(</span><span class="s1">'ERROR: `shift_beta` &gt; 1 in `userInitParticles()`'</span><span class="p">)</span><span class="w"> </span><span class="c1">! &lt; this will stop simulation with an error</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span><span class="n">shift_gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shift_beta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="w">
</span><span class="c1">!     to ensure `B^2/2 = sigma T n me c^2`</span><span class="w">
</span><span class="n">current_sheet_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigma</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="n">nCS_over_nUP</span><span class="w">
</span></code></pre></div></div>

<p>Notice the <code class="language-plaintext highlighter-rouge">fill_region</code> variable of <code class="language-plaintext highlighter-rouge">type (region)</code> declared above. That object basically defines a region (on a domain or <a href="tristanv2-structure.html#domains">meshblock</a>) where the plasma will be sprinkled (i.e., we will be passing that variable to an injection routine). In this case we will be filling the entire domain, and will take care about spatial distribution function later. So for now, we will specify the entire domain as the dimensions of this region:</p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fill_region</span><span class="o">%</span><span class="n">x_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">
</span><span class="n">fill_region</span><span class="o">%</span><span class="n">y_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">
</span><span class="n">fill_region</span><span class="o">%</span><span class="n">x_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">global_mesh</span><span class="o">%</span><span class="n">sx</span><span class="p">)</span><span class="w">
</span><span class="n">fill_region</span><span class="o">%</span><span class="n">y_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">global_mesh</span><span class="o">%</span><span class="n">sy</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> If you are unfamiliar with <code class="language-plaintext highlighter-rouge">this_meshblock%ptr</code> etc, take a look at <a href="tristanv2-structure.html#domains">this section</a>.</div>

<p>After that we are ready to inject the upstream particles. For that we will need to call the <code class="language-plaintext highlighter-rouge">fillRegionWithThermalPlasma()</code> routine and pass the following variables:</p>
<ol>
  <li>the filling region, <code class="language-plaintext highlighter-rouge">fill_region</code>;</li>
  <li>all the species as an array, in this case it’s just <code class="language-plaintext highlighter-rouge">/(1, 2)/</code>;</li>
  <li>the number of species passed, i.e., length of the array above, in this case – <code class="language-plaintext highlighter-rouge">2</code>;</li>
  <li>initialization density for all of the species;</li>
  <li>the temperature.</li>
</ol>

<p>The upstream plasma is sprinkled everywhere and with the zero drift, so we don’t need to specify anything else. For the current sheet, however, we will need to specify a few other things:</p>

<ol start="6">
  <li>drift velocity – Lorentz factor of the boosted Maxwellian, <code class="language-plaintext highlighter-rouge">shift_gamma</code>;</li>
  <li>direction of the boost (<code class="language-plaintext highlighter-rouge">+/-1 = +/-x</code>, <code class="language-plaintext highlighter-rouge">+/-2 = +/-y</code>, <code class="language-plaintext highlighter-rouge">+/-3 = +/-z</code>): by default positively charged particles are boosted in the direction specified, negatively charged ones – in the opposite direction;</li>
  <li>pointer to the predefined spatial distribution function, <code class="language-plaintext highlighter-rouge">spat_distr_ptr</code>;</li>
  <li>a few variables to pass to the spatial distribution function (if necessary).</li>
</ol>

<p>Here’s what the injection looks like:</p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sx_glob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">global_mesh</span><span class="o">%</span><span class="n">sx</span><span class="p">)</span><span class="w"> </span><span class="c1">! &lt;- define global simulation size in `x`</span><span class="w">

</span><span class="c1">! now filling region with plasma</span><span class="w">
</span><span class="c1">!     upstream:</span><span class="w">
</span><span class="k">call</span><span class="w"> </span><span class="n">fillRegionWithThermalPlasma</span><span class="p">(</span><span class="n">fill_region</span><span class="p">,</span><span class="w"> </span><span class="p">(/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">/),</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">nUP</span><span class="p">,</span><span class="w"> </span><span class="n">upstream_T</span><span class="p">)</span><span class="w">
</span><span class="c1">!     current sheet #1:</span><span class="w">
</span><span class="c1">!       positrons fly in +z</span><span class="w">
</span><span class="k">call</span><span class="w"> </span><span class="n">fillRegionWithThermalPlasma</span><span class="p">(</span><span class="n">fill_region</span><span class="p">,</span><span class="w"> </span><span class="p">(/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">/),</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">nCS</span><span class="p">,</span><span class="w"> </span><span class="n">current_sheet_T</span><span class="p">,&amp;</span><span class="w">
                               </span><span class="p">&amp;</span><span class="w"> </span><span class="n">shift_gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shift_gamma</span><span class="p">,</span><span class="w"> </span><span class="n">shift_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,&amp;</span><span class="w">
                               </span><span class="p">&amp;</span><span class="w"> </span><span class="n">spat_distr_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spat_distr_ptr</span><span class="p">,&amp;</span><span class="w">
                               </span><span class="p">&amp;</span><span class="w"> </span><span class="n">dummy1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cs_x1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sx_glob</span><span class="p">,</span><span class="w"> </span><span class="n">dummy2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_width</span><span class="p">)</span><span class="w">
</span><span class="c1">!     current sheet #2:</span><span class="w">
</span><span class="c1">!       positrons fly in -z</span><span class="w">
</span><span class="k">call</span><span class="w"> </span><span class="n">fillRegionWithThermalPlasma</span><span class="p">(</span><span class="n">fill_region</span><span class="p">,</span><span class="w"> </span><span class="p">(/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">/),</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">nCS</span><span class="p">,</span><span class="w"> </span><span class="n">current_sheet_T</span><span class="p">,&amp;</span><span class="w">
                               </span><span class="p">&amp;</span><span class="w"> </span><span class="n">shift_gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shift_gamma</span><span class="p">,</span><span class="w"> </span><span class="n">shift_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-3</span><span class="p">,&amp;</span><span class="w">
                               </span><span class="p">&amp;</span><span class="w"> </span><span class="n">spat_distr_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spat_distr_ptr</span><span class="p">,&amp;</span><span class="w">
                               </span><span class="p">&amp;</span><span class="w"> </span><span class="n">dummy1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cs_x2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sx_glob</span><span class="p">,</span><span class="w"> </span><span class="n">dummy2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_width</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">fillRegionWithThermalPlasma</code> creates particles of specified species (positioned at the same location) with a specified density, temperature and boost. <code class="language-plaintext highlighter-rouge">dummy1</code> and <code class="language-plaintext highlighter-rouge">dummy2</code> are the two optional parameters, in this case the position and the width of the current sheet, passed to the spatial distribution function.</p>

<p>The latter needs to be also defined in the user file. Notice that <code class="language-plaintext highlighter-rouge">spat_distr_ptr</code> in the declaration above is at the moment pointing at a function <code class="language-plaintext highlighter-rouge">userSpatialDistribution()</code> also defined in the user file. That <code class="language-plaintext highlighter-rouge">userSpatialDistribution()</code> is basically a “wave function” for the particle, that returns a probability to inject a particle in a particular location <code class="language-plaintext highlighter-rouge">x_glob</code>, <code class="language-plaintext highlighter-rouge">y_glob</code>, <code class="language-plaintext highlighter-rouge">z_glob</code>. Let us define it in such a way that it injects particles primarily around our current sheets. Since we will be using the <code class="language-plaintext highlighter-rouge">tanh</code> profile for the b-field, we’ll need to use <code class="language-plaintext highlighter-rouge">1/cosh^2</code> for the density, so we can simply change the “wave function” to the following:</p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="w"> </span><span class="n">userSpatialDistribution</span><span class="p">(</span><span class="n">x_glob</span><span class="p">,</span><span class="w"> </span><span class="n">y_glob</span><span class="p">,</span><span class="w"> </span><span class="n">z_glob</span><span class="p">,&amp;</span><span class="w">
                               </span><span class="p">&amp;</span><span class="w"> </span><span class="n">dummy1</span><span class="p">,</span><span class="w"> </span><span class="n">dummy2</span><span class="p">,</span><span class="w"> </span><span class="n">dummy3</span><span class="p">)</span><span class="w">
  </span><span class="kt">real</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">userSpatialDistribution</span><span class="w">
  </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">  </span><span class="p">::</span><span class="w"> </span><span class="n">x_glob</span><span class="p">,</span><span class="w"> </span><span class="n">y_glob</span><span class="p">,</span><span class="w"> </span><span class="n">z_glob</span><span class="w">
  </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">  </span><span class="p">::</span><span class="w"> </span><span class="n">dummy1</span><span class="p">,</span><span class="w"> </span><span class="n">dummy2</span><span class="p">,</span><span class="w"> </span><span class="n">dummy3</span><span class="w">
  </span><span class="c1">! dummy1 -&gt; position of the current sheet</span><span class="w">
  </span><span class="c1">! dummy2 -&gt; width of the current sheet</span><span class="w">
  </span><span class="n">userSpatialDistribution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="p">(</span><span class="nb">cosh</span><span class="p">((</span><span class="n">x_glob</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dummy1</span><span class="p">)</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="n">dummy2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="w">
  </span><span class="k">return</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w">
</span></code></pre></div></div>

<div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> detailed description of particle structure can be found <a href="...">here</a>.</div>

<h3 id="initializing-fields">Initializing fields</h3>
<p>Field initialization is fairly straightforward, except that we need to worry about the staggering. In this case we will only be initializing the <code class="language-plaintext highlighter-rouge">by</code> as a function of <code class="language-plaintext highlighter-rouge">x</code>, so we don’t have to worry about staggering at all. Here is what the <code class="language-plaintext highlighter-rouge">userInitFields()</code> routine should look like:</p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">subroutine</span><span class="w"> </span><span class="n">userInitFields</span><span class="p">()</span><span class="w">
  </span><span class="k">implicit</span><span class="w"> </span><span class="k">none</span><span class="w">
  </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w">
  </span><span class="kt">real</span><span class="w">    </span><span class="p">::</span><span class="w"> </span><span class="n">sx_glob</span><span class="p">,</span><span class="w"> </span><span class="n">x_glob</span><span class="w">
  </span><span class="c1">! initializing everything to zero</span><span class="w">
  </span><span class="n">ex</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ey</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ez</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="n">bx</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">by</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">bz</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="n">jx</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jy</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jz</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">

  </span><span class="n">sx_glob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">global_mesh</span><span class="o">%</span><span class="n">sx</span><span class="p">)</span><span class="w">
  </span><span class="c1">! loop through all the cells</span><span class="w">
  </span><span class="k">do</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">this_meshblock</span><span class="o">%</span><span class="n">ptr</span><span class="o">%</span><span class="n">sx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="c1">! converting to global (explicit conversion is optional)</span><span class="w">
    </span><span class="n">x_glob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">this_meshblock</span><span class="o">%</span><span class="n">ptr</span><span class="o">%</span><span class="n">x0</span><span class="p">)</span><span class="w">
    </span><span class="k">do</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">this_meshblock</span><span class="o">%</span><span class="n">ptr</span><span class="o">%</span><span class="n">sy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
      </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">this_meshblock</span><span class="o">%</span><span class="n">ptr</span><span class="o">%</span><span class="n">sz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
        </span><span class="c1">! no staggering in this case</span><span class="w">
        </span><span class="n">by</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tanh</span><span class="p">((</span><span class="n">x_glob</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cs_x1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sx_glob</span><span class="p">)</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="n">current_width</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="p">&amp;</span><span class="w">
                    </span><span class="p">&amp;</span><span class="w"> </span><span class="nb">tanh</span><span class="p">((</span><span class="n">x_glob</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cs_x2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sx_glob</span><span class="p">)</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="n">current_width</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
    </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">do</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">userInitFields</span><span class="w">
</span></code></pre></div></div>
<div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> For details about the fields see <a href="tristanv2-structure.html#fields">here</a>.</div>

<hr />

<p>And that’s it. If you run it and read the initial data, it will produce something similar to this (left panel: density, right panel: <code class="language-plaintext highlighter-rouge">by</code>):</p>
<figure><img class="docimage" src="images/tristan_v2/guides/2d2prec.png" alt="2d2prec" /></figure>

<div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> To learn how to read the output and visualize the data, please read the following <a href="...">chapter</a>.</div>


    <div class="tags">
        
    </div>




</div>

<hr class="shaded"/>

<footer>
<div class="row">
  <div class="col-lg-12 footer">
    &copy;2019 Plasmoids. All rights reserved. <br />
<span>Page last updated:</span> Dec 17, 2019<br/> Site last generated: Dec 22, 2019 <br />
  </div>
</div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>
</body>
</html>
